<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8">
    <title>Windup APIs</title>
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/css/patternfly.min.css">
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/css/patternfly-additions.min.css">
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-body">
                <h2 class="card-title">Analysis</h2>
                <h3 class="card-title">Sample Configuration</h3>
                <button class="btn btn-info" id="request-sample-analysis">Request Analysis with sample configuration</button>
                <h3 class="card-title">Custom Configuration</h3>
                <form id="request-analysis-form">
                    <label for="application">Choose the application to be analyzed *</label>
                    <input type="file" id="application" name="application">
                    <input id="applicationFileName" type="hidden" name="applicationFileName" value=""/>
                    <label for="sources">Provide the analysis sources (comma-separated)</label>
                    <input type="text" id="sources" name="sources" size="50">
                    <br/>
                    <label for="targets">Provide the analysis targets (comma-separated) *</label>
                    <input type="text" id="targets" name="targets" value="eap7,cloud-readiness,quarkus,rhr" size="50">
                    <br/>
                    <label for="packages">Provide the analysis packages (comma-separated)</label>
                    <input type="text" id="packages" name="packages" size="50">
                    <br/>
                    <label for="sourceMode">Check if application's source code is provided</label>
                    <input type="checkbox" id="sourceMode" name="sourceMode">
                </form>
                <button class="btn btn-info" id="request-analysis">Request Analysis with custom configuration</button>
                <h3 class="card-title">Executions</h3>
                <div class="analysis"></div>
            </div>
        </div>
    </div>
</body>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $("#request-sample-analysis").click((event) => {
        fetch("/windup/trigger", {method: "GET"})
            .then(res => res.headers.get("Analysis-Id"))
            .then(analysisId => {
                var row = $(`<h4 class='col-md-12' id='${analysisId}'>Analysis #<i>${analysisId}</i>: <strong>Pending</strong></h4>`);
                $(".analysis").append(row);
            });
    });
    $("#request-analysis").click((event) => {
        event.preventDefault();
        fetch("/windup/analysis", {
            method: "POST",
            body: new FormData(document.getElementById("request-analysis-form"))
            })
            .then(res => {
                if (!res.ok) {
                    alert(`Failure in triggering the analysis (Status ${res.status})`);
                }
                return res.headers.get("Analysis-Id");
            })
            .then(analysisId => {
                var row = $(`<h4 class='col-md-12' id='${analysisId}'>Analysis #<i>${analysisId}</i>: <strong>Pending</strong></h4>`);
                $(".analysis").append(row);
            });
    });
    var source = new EventSource("/windup/analysisSse/");
    source.onmessage = (event) => {
        var json = JSON.parse(event.data);
        console.log("event received " + json.state);
/*        $(`#${json.id}`).html(function(index, html) {
            return html.replace("Pending", `\$\xA0${json.state}`);
        });*/
        $(`#${json.id} strong`).text(`${json.state}\xA0[${json.workCompleted}\\${json.totalWork + 1}]`);
        if (json.state === 'MERGED') {
            var issues = $(`<a href='/windup/analysis/${json.id}/issues' target='_blank'>Issues</a>`)
            $(`#${json.id}`).append(issues);
        }
    };
    document.getElementById('application').onchange = function () {
        document.getElementById('applicationFileName').value = this.files.item(0).name;
    };
</script>
</html>

